---
title: "Untitled"
author: "Kerim Acar"
date: "16 Aralýk 2018"
output: html_document
runtime: shiny
---
## Introduction

The following analyses are conducted based on the sales figures of an FMCG company.
Data shows us datails such as invoice date,sales amount,purchased item,item categories etc. It also includes info about customer characteristics like gender, age,address, segmentation, loyalty.Processed data is 31.2 MB. There are approximately 494K rows with 15 attributes.

Data Fields:

INVOICEID,
ACCOUNTNUM,
GENDER,
AGE,
LOA(kind of loyalty indicator)
CITY,
CUSTOMER SEGMENT,
BUSINESS,
CATEGORY,
SEGMENT,
SALES,
UNIT PRICE,
QUANTITY,
FIRST ORDER,
INVOICE DATE

# Analysis-Necessary Packages
```{r message = FALSE}
library(dplyr)
library(tidyverse)
library(ggplot2)
library(scales)
library(readxl)
library(lubridate)
library(treemapify) 
library(magrittr)
library(sp)
library(mapproj)
```

#
Excel file is downloaded from github to a local data frame (raw_data) and prepared for analysis

```{r}
project_raw_data <- read_excel(
  "C:/Users/kerim.acar/Desktop/BDA/BDA503/Project/sales_data_v10.xlsx")
project_raw_data$SALES <- as.numeric(gsub(",", ".", gsub("\\.", "", project_raw_data$SALES)))
project_raw_data$UNIT_PRICE <- as.numeric(gsub(",", ".", gsub("\\.", "", project_raw_data$UNIT_PRICE)))
glimpse(project_raw_data)
dim(project_raw_data)

total <- read.csv(
  "C:/Users/kerim.acar/Desktop/BDA/BDA503/Project/final_map.csv",sep = ",",
  colClasses=c("group"="factor"))
body <- read.csv(
  "C:/Users/kerim.acar/Desktop/BDA/BDA503/Project/body_final_map.csv",sep = ",",
  colClasses=c("group"="factor"))
face <- read.csv(
  "C:/Users/kerim.acar/Desktop/BDA/BDA503/Project/face_final_map.csv",sep = ",",
  colClasses=c("group"="factor"))
jewelry <- read.csv(
  "C:/Users/kerim.acar/Desktop/BDA/BDA503/Project/jewelry_final_map.csv",sep = ",",
  colClasses=c("group"="factor"))
fragrance <- read.csv(
  "C:/Users/kerim.acar/Desktop/BDA/BDA503/Project/fragrance_final_map.csv",sep = ",",
  colClasses=c("group"="factor"))
toiletries <- read.csv(
  "C:/Users/kerim.acar/Desktop/BDA/BDA503/Project/toiletries_final_map.csv",sep = ",",
  colClasses=c("group"="factor"))
color <- read.csv(
  "C:/Users/kerim.acar/Desktop/BDA/BDA503/Project/color_final_map.csv",sep = ",",
  colClasses=c("group"="factor"))
```

The first plot in following shows us the total sales for 3 business segments(Beauty, Fashion and Home).Accordingly, the main business category of this company is 'beauty', since the majority of sales comes from this group.'Fashion' has also small share in total sales, while 'home'share in total is negligible. 
From A to J, there are 10 customer segments in total.
The other output out of the first graph is the  contribution amount of every single customer segment to total sales.It is showed that, customers in D segment brings the highest contribution; while  F and J segment follow it,respectively.



The second graph shows the average sales for each segment. Once we compare it with the previous one, it results in the fact that, the middle segments have the higher contribution to total sales.However, J segment, which is the premium one, has the highest average sales among all. The reason is,the number of customers in this premium (J segment) is quite low.But their total sales amount is quite high. Therefore, the average sales of this J segment is the highest one.


```{r}
sales_by_acc_loa <- 
  project_raw_data %>% 
  select(ACCOUNTNUM, LOA,Customer_Segment,SALES,BUSINESS) %>%
  group_by(ACCOUNTNUM, LOA,Customer_Segment,BUSINESS) %>% 
  summarise(total_sales=sum(SALES))

glimpse(sales_by_acc_loa)

total_sales_by_segment_bus <- 
  sales_by_acc_loa %>% 
  group_by(Customer_Segment, BUSINESS) %>% 
  summarise(total_segment_bus_sales=sum(total_sales))

total_sales_by_segment_bus %>% 
        ggplot(aes(x=Customer_Segment, y=total_segment_bus_sales, fill=BUSINESS )) + 
        geom_bar(stat="identity")+
        labs( x="Customer Segment" , y = "Total sales")+
        ggtitle("total sales based on Sales Representative Segment") +
        theme(legend.position = "bottom", axis.text.x = element_text(angle = 0.0, vjust = 0.0, hjust = 0.0, size = 10))

avg_sales_by_segment_bus <- 
  sales_by_acc_loa %>% 
  group_by(Customer_Segment, BUSINESS) %>% 
  summarise(total_segment_bus_sales=mean(total_sales))

avg_sales_by_segment_bus %>% 
        ggplot(aes(x=Customer_Segment, y=total_segment_bus_sales, fill=BUSINESS )) + 
        geom_bar(stat="identity")+
        labs( x="Customer Segment" , y = "Average Sales")+
        ggtitle("average sales based on Sales Representative Segment") +
        theme(legend.position = "bottom", axis.text.x = element_text(angle = 0.0, vjust = 0.0, hjust = 0.0, size = 10))

```

#
In the third graph, top 20 cities,based on their total sales amount are showed.Istabul,Bursa and izmir are in top 3.

```{r}
sales_by_city <- 
        project_raw_data %>% 
        group_by(CITY) %>% 
        summarise(total_sales=sum(SALES)) %>% 
        arrange(desc(total_sales)) %>%
        slice(1:20)

glimpse(sales_by_city)

sales_by_city %>% 
                  ggplot(aes(x=reorder(CITY,total_sales), y=total_sales, fill=CITY )) + 
                  geom_bar(stat="identity")+
                  coord_flip()+
                  labs( x="CITY" , y = "Total sales")+
                  ggtitle("total sales based on city") +
                  theme(legend.position = "none", axis.text.x = element_text(angle = 0.0, vjust = 0.0, hjust = 0.0, size = 1))
```

#

In the 4th graph, weekdays are desired to compared with respect to their sales contribution, distributon is given in a pie chart.Saturday has slightly lower share in a week.


```{r}
sales_per_day <-
        project_raw_data %>% 
        select(INVOICE_DATE,SALES) %>%
        mutate(INVOICE_DATE2=lubridate::as_date(ymd(INVOICE_DATE))) %>%
        mutate(weekday=weekdays(INVOICE_DATE2)) %>%
        group_by(weekday) %>%
        summarise(avg_sale=mean(SALES))  %>%
        mutate(day_order=c(5,6,3,7,1,4,2)) %>%
        arrange(day_order)

glimpse(sales_per_day)

sales_per_day %>%
        ggplot(aes(x="",y=avg_sale, fill=reorder(weekday,day_order))) + 
        geom_bar(stat="identity")+
        coord_polar("y",start = 0)+
        theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.grid  = element_blank())
```

#

There are sub- categories in each of the business units.To illustrate,'beauty' business category includes 5 different sub-categories; such as 'body','toiletries','face','fragnance','color'.
5th graph in below shows us the share of all these sub-categories in total sales.Bigger area indicates bigger share. Accordingly, fragnance is the first, and it is followed by toiletres and color respectively.


```{r}

categorized_sales <-
  project_raw_data %>% 
  select(CATEGORY_, SALES) %>%
  group_by(CATEGORY_) %>%
  summarise(SALES = sum(SALES)) 

ggplot(categorized_sales, aes(area = SALES, fill = CATEGORY_, label = CATEGORY_)) +
  geom_treemap() +
  geom_treemap_text(fontface = "italic", colour = "white", place = "centre", grow = TRUE)+
  theme(legend.position = "bottom") 
```


## Company Sales Relative Frequency Distribution of Turkey by Categories

You can embed Shiny inputs and outputs in your document. Outputs are automatically updated whenever inputs change.  This demonstrates how a standard R plot can be made interactive by wrapping it in the Shiny `renderPlot` function. The `selectInput` and `sliderInput` functions create the input widgets used to drive the plot.

```{r eruptions, echo=FALSE}
inputPanel(
  selectInput("categories",
                  "categories",
                  choices = c("ALL","BODY","FACE","JEWELRY","FRAGRANCE",
                              "TOILETRIES","COLOR"))
)

renderPlot({

    if(input$categories == "ALL") {
      ggplot(total)+geom_polygon( aes(x = long, y = lat, group = group, 
                                          fill = rel_freqs),
                                      color = "grey") +
        coord_map() +theme_void() + labs(
          title = "Relative Frequency Distribution of ALL Sales") +
        scale_fill_distiller(name = "Frequency Table",palette = "Spectral", 
                             limits = c(0,0.065),
                             na.value = "red") +
        theme(plot.title = element_text(hjust = 0.5),
              plot.subtitle = element_text(hjust = 0.5))
    }
    else if (input$categories == "BODY") {
      ggplot(body)+geom_polygon( aes(x = long, y = lat, group = group, 
                                               fill = rel_freqs),
                                           color = "grey") +
        coord_map() +theme_void() + labs(
          title = "Relative Frequency Distribution of BODY Sales") +
        scale_fill_distiller(name = "Frequency Table",palette = "Spectral", 
                             limits = c(0,0.08),
                             na.value = "red") +
        theme(plot.title = element_text(hjust = 0.5),
              plot.subtitle = element_text(hjust = 0.5))
    }
    else if (input$categories == "FACE") {
      ggplot(face)+geom_polygon( aes(x = long, y = lat, group = group, 
                                     fill = rel_freqs),
                                 color = "grey") +
        coord_map() +theme_void() + labs(
          title = "Relative Frequency Distribution of FACE Sales") +
        scale_fill_distiller(name = "Frequency Table",palette = "Spectral", 
                             limits = c(0,0.06),
                             na.value = "red") +
        theme(plot.title = element_text(hjust = 0.5),
              plot.subtitle = element_text(hjust = 0.5))
    }
    else if (input$categories == "JEWELRY") {
      ggplot(jewelry)+geom_polygon( aes(x = long, y = lat, group = group, 
                                     fill = rel_freqs),
                                 color = "grey") +
        coord_map() +theme_void() + labs(
          title = "Relative Frequency Distribution of JEWELRY Sales") +
        scale_fill_distiller(name = "Frequency Table",palette = "Spectral", 
                             limits = c(0,0.07),
                             na.value = "red") +
        theme(plot.title = element_text(hjust = 0.5),
              plot.subtitle = element_text(hjust = 0.5))
    }
    else if (input$categories == "FRAGRANCE") {
      ggplot(fragrance)+geom_polygon( aes(x = long, y = lat, group = group, 
                                        fill = rel_freqs),
                                    color = "grey") +
        coord_map() +theme_void() + labs(
          title = "Relative Frequency Distribution of FRAGRANCE Sales") +
        scale_fill_distiller(name = "Frequency Table",palette = "Spectral", 
                             limits = c(0,0.06),
                             na.value = "red") +
        theme(plot.title = element_text(hjust = 0.5),
              plot.subtitle = element_text(hjust = 0.5))
    }
    else if (input$categories == "TOILETRIES") {
      ggplot(toiletries)+geom_polygon( aes(x = long, y = lat, group = group, 
                                          fill = rel_freqs),
                                      color = "grey") +
        coord_map() +theme_void() + labs(
          title = "Relative Frequency Distribution of TOILETRIES Sales") +
        scale_fill_distiller(name = "Frequency Table",palette = "Spectral", 
                             limits = c(0,0.065),
                             na.value = "red") +
        theme(plot.title = element_text(hjust = 0.5),
              plot.subtitle = element_text(hjust = 0.5))
    }
    else if (input$categories == "COLOR") {
      ggplot(color)+geom_polygon( aes(x = long, y = lat, group = group, 
                                           fill = rel_freqs),
                                       color = "grey") +
        coord_map() +theme_void() + labs(
          title = "Relative Frequency Distribution of COLOR Sales") +
        scale_fill_distiller(name = "Frequency Table",palette = "Spectral", 
                             limits = c(0,0.05),
                             na.value = "red") +
        theme(plot.title = element_text(hjust = 0.5),
              plot.subtitle = element_text(hjust = 0.5))
    }
    
    
    
  })
```

